<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NGYD7E9JVG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-NGYD7E9JVG');
    </script>
    <meta charset="UTF-8">
    <title>相談アーカイブ｜ゆい姉さんの相談室</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="過去の恋愛相談一覧です。あなたの悩みに関連する記事を探してみてください。">
    
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>

<body>
    <div class="site-wrapper">
        <aside class="sidebar-left">
            <div class="yui-word"><strong>ゆい姉さん今日の一言</strong><br><span id="daily-msg">読み込み中...</span></div>
            <button class="omikuji-btn" onclick="drawOmikuji()">ゆい姉さんおみくじ</button>
            <div id="omikuji-result"
                style="margin-top:10px; font-size:0.85rem; color:#d63384; text-align:center; font-weight:bold;"></div>
            <div class="ad-container">
                <!-- 広告1 -->
                <div class="ad-space">
                    <a href="https://px.a8.net/svt/ejp?a8mat=3T8ZHQ+8NDQ5U+22QA+HZXM9" rel="nofollow">
                        <img border="0" height="250" alt=""
                            src="https://www21.a8.net/svt/bgt?aid=230526638523&wid=001&eno=01&mid=s00000009685003023000&mc=1"></a>
                    <img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=3T8ZHQ+8NDQ5U+22QA+HZXM9"
                        alt="">
                </div>
                <!-- 広告2 -->
                <div class="ad-space">
                    <a href="https://px.a8.net/svt/ejp?a8mat=3T909J+7N2A9E+9FQ+6DRLT" rel="nofollow">
                        <img border="0" height="250" alt=""
                            src="https://www26.a8.net/svt/bgt?aid=230527639462&wid=001&eno=01&mid=s00000001223001072000&mc=1"></a>
                    <img border="0" width="1" height="1" src="https://www13.a8.net/0.gif?a8mat=3T909J+7N2A9E+9FQ+6DRLT"
                        alt="">
                </div>
            </div>
        </aside>

        <main class="container">
            <div class="site-intro" style="text-align:center;">
                <p>過去の相談をキーワードで検索できるわ。</p>
                <div class="search-box" style="text-align:center; margin-top:20px;">
                    <input type="text" id="archive-search" placeholder="キーワードを入力（例：復縁、LINE）"
                        style="width:80%; max-width:400px; padding:10px; font-size:1rem;">
                </div>
                <p id="result-count" style="font-size:0.9rem; color:#666; margin-top:10px;"></p>
            </div>

            <!-- カテゴリータブ -->
            <div class="category-tabs" id="category-tabs" style="margin: 30px 0;">
                <button class="cat-tab active" onclick="filterByCat('すべて', this)">すべて</button>
                <button class="cat-tab" onclick="filterByCat('片思い', this)">片思い</button>
                <button class="cat-tab" onclick="filterByCat('彼氏・彼女', this)">彼氏・彼女</button>
                <button class="cat-tab" onclick="filterByCat('結婚', this)">結婚</button>
                <button class="cat-tab" onclick="filterByCat('出会い', this)">出会い</button>
                <button class="cat-tab" onclick="filterByCat('復縁・別れ', this)">復縁・別れ</button>
                <button class="cat-tab" onclick="filterByCat('夜の悩み', this)">夜の悩み</button>
            </div>

            <!-- 注目記事セクション -->
            <div id="featured-articles" style="margin: 30px 0;">
                <p style="text-align:center;">読み込み中...</p>
            </div>

            <hr style="border: 0; border-top: 2px solid #ffecf2; margin: 40px 0;">
            <h2 style="color:#d63384; margin-bottom:20px;">すべての相談アーカイブ</h2>

            <div id="archive-list" class="archive-grid">
                <p style="text-align:center;">読み込み中...</p>
            </div>

            <div id="pagination" style="text-align:center; margin-top:40px; display:none;">
                <button id="load-more-btn" class="omikuji-btn" style="width:auto; padding:10px 30px;">もっと見る</button>
            </div>
        </main>

        <!-- モバイル用広告エリア（ページ下部） -->
        <div class="mobile-ad-area">
            <!-- 広告1 -->
            <div class="ad-space">
                <a href="https://px.a8.net/svt/ejp?a8mat=3T8ZHQ+8NDQ5U+22QA+HZXM9" rel="nofollow">
                    <img border="0" height="250" alt=""
                        src="https://www21.a8.net/svt/bgt?aid=230526638523&wid=001&eno=01&mid=s00000009685003023000&mc=1"></a>
                <img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=3T8ZHQ+8NDQ5U+22QA+HZXM9"
                    alt="">
            </div>
            <!-- 広告2 -->
            <div class="ad-space">
                <a href="https://px.a8.net/svt/ejp?a8mat=3T909J+7N2A9E+9FQ+6DRLT" rel="nofollow">
                    <img border="0" height="250" alt=""
                        src="https://www26.a8.net/svt/bgt?aid=230527639462&wid=001&eno=01&mid=s00000001223001072000&mc=1"></a>
                <img border="0" width="1" height="1" src="https://www13.a8.net/0.gif?a8mat=3T909J+7N2A9E+9FQ+6DRLT"
                    alt="">
            </div>
        </div>

        <aside class="sidebar-right">
            <div class="note-box">
                <iframe src="https://note.com/embed/notes/nea7132e15dbe"
                    style="border: 0; display: block; max-width: 100%; width: 100%; padding: 0px; margin: 10px 0; position: static; visibility: visible;"
                    height="400"></iframe>
            </div>
            <a href="profile.html" class="bubble">ゆい姉さんのプロフィール</a>
            <img src="yui.png" alt="ゆい姉さん" class="yui-img">
        </aside>
    </div>

    <footer style="text-align:center; padding:40px; color:#999; font-size:0.8rem;">
        <p>&copy; 2026 ゆい姉さんの恋愛相談室</p>
    </footer>

    <!-- モバイル用フローティングボタン -->
    <a href="profile.html" class="mobile-profile-btn">
        <img src="yuichibi.png" alt="プロフィールへ">
    </a>

    <script src="data/questions.js"></script>
    <script>
        // おみくじと今日の一言のロジックを追加
        const words = ["自分を大切にね。", "明日はきっといい日になるわ。", "あなたの味方はここにいるわ。"];
        if (document.getElementById('daily-msg')) {
            document.getElementById('daily-msg').innerText = words[Math.floor(Math.random() * words.length)];
        }

        function drawOmikuji() {
            const res = ["大吉：最高の出会いがあるかも！", "中吉：自分磨きが吉。", "吉：幸せが見つかる予感。"];
            if (document.getElementById('omikuji-result')) {
                document.getElementById('omikuji-result').innerText = res[Math.floor(Math.random() * res.length)];
            }
        }
        let allPosts = [];
        let displayedCount = 0;
        const LOAD_STEP = 24;
        let currentCategory = 'すべて';

        // カテゴリーマッピング (index.htmlと同じ)
        const mapping = {
            '片思い': ['片思い', '初デート', '告白'],
            '彼氏・彼女': ['付き合って3ヶ月', '付き合って1年', '不信感', '信頼関係', '嫉妬', '浮気'],
            '結婚': ['結婚', '結婚前', '義実家', '義理'],
            '出会い': ['マッチングアプリ', '出会い', '合コン'],
            '復縁・別れ': ['別れ', '別れた後', '元彼', '復縁'],
            '夜の悩み': ['夜の', 'セフレ', '性生活', '都合のいい関係']
        };

        function getCategory(post) {
            const content = post.title + post.description;
            for (const [cat, keywords] of Object.entries(mapping)) {
                if (keywords.some(k => content.includes(k))) return cat;
            }
            return 'その他';
        }

        function filterByCat(cat, btn) {
            // タブの活性化
            document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            currentCategory = cat;

            // 検索クエリをクリア
            document.getElementById('archive-search').value = '';

            // 注目記事とアーカイブを再レンダリング
            renderFeaturedArticles();
            filterAndRender('');
        }

        function getTodayStr() {
            const now = new Date();
            // JST (UTC+9) に調整
            const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            return jstNow.toISOString().split('T')[0].replace(/-/g, '.');
        }

        function renderFeaturedArticles() {
            const container = document.getElementById('featured-articles');
            const todayStr = getTodayStr();
            const livePosts = allPosts.filter(post => post.date <= todayStr);

            if (currentCategory === 'すべて') {
                // すべてের カテゴリーから3記事ずつ表示
                let html = '';
                for (const cat of ['片思い', '彼氏・彼女', '結婚', '出会い', '復縁・別れ', '夜の悩み']) {
                    const catPosts = livePosts.filter(post => getCategory(post) === cat).slice(0, 3);
                    if (catPosts.length > 0) {
                        html += `
                            <div style="margin-bottom: 40px;">
                                <h3 style="color:#d63384; border-left: 4px solid #ffc0cb; padding-left: 10px; margin-bottom: 15px;">${cat}</h3>
                                <div class="archive-grid" style="margin-bottom: 20px;">
                                    ${catPosts.map(post => `
                                        <a href="${post.url}" class="post-card">
                                            <div class="date">${post.date}</div>
                                            <div class="title">${post.title}</div>
                                            <div style="font-size:0.85rem; color:#666; margin-top:5px; height:4.5em; overflow:hidden;">${post.description.substring(0, 60)}...</div>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
                container.innerHTML = html || '<p style="text-align:center;">記事がありません。</p>';
            } else {
                // 選択されたカテゴリーから6記事表示
                const catPosts = livePosts.filter(post => getCategory(post) === currentCategory).slice(0, 6);
                if (catPosts.length > 0) {
                    container.innerHTML = `
                        <h3 style="color:#d63384; border-left: 4px solid #ffc0cb; padding-left: 10px; margin-bottom: 15px;">${currentCategory}の注目記事</h3>
                        <div class="archive-grid">
                            ${catPosts.map(post => `
                                <a href="${post.url}" class="post-card">
                                    <div class="date">${post.date}</div>
                                    <div class="title">${post.title}</div>
                                    <div style="font-size:0.85rem; color:#666; margin-top:5px; height:4.5em; overflow:hidden;">${post.description.substring(0, 60)}...</div>
                                </a>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="text-align:center;">このカテゴリーの記事はまだありません。</p>';
                }
            }
        }

        let currentFilteredPosts = [];

        // URLパラメータから検索クエリを取得
        const urlParams = new URLSearchParams(window.location.search);
        const initialQuery = urlParams.get('q') || '';
        document.getElementById('archive-search').value = initialQuery;

        // 記事読み込み (questions.jsから取得)
        if (typeof questionsData !== 'undefined') {
            // 日付降順にソート（念のため）
            allPosts = questionsData.sort((a, b) => {
                const dateA = a.date.replace(/\./g, '/');
                const dateB = b.date.replace(/\./g, '/');
                return new Date(dateB) - new Date(dateA);
            });

            // 注目記事を表示
            renderFeaturedArticles();

            // 初期表示
            filterAndRender(initialQuery);
        } else {
            document.getElementById('archive-list').innerHTML = '<p>データの読み込みに失敗しました。</p>';
            document.getElementById('featured-articles').innerHTML = '<p>データの読み込みに失敗しました。</p>';
        }

        document.getElementById('archive-search').addEventListener('input', (e) => {
            filterAndRender(e.target.value);
        });

        document.getElementById('load-more-btn').addEventListener('click', () => {
            renderPosts(currentFilteredPosts, true);
        });

        function filterAndRender(query) {
            const container = document.getElementById('archive-list');
            container.innerHTML = '';
            displayedCount = 0;

            // カテゴリーでフィルタリング
            const todayStr = getTodayStr();
            let basePosts = allPosts.filter(post => post.date <= todayStr);
            if (currentCategory !== 'すべて') {
                basePosts = basePosts.filter(post => getCategory(post) === currentCategory);
            }

            // 検索クエリでフィルタリング
            if (!query) {
                currentFilteredPosts = basePosts;
            } else {
                const lowerQ = query.toLowerCase();
                currentFilteredPosts = basePosts.filter(post =>
                    post.title.toLowerCase().includes(lowerQ) ||
                    post.description.toLowerCase().includes(lowerQ)
                );
            }

            document.getElementById('result-count').innerText = `全${currentFilteredPosts.length}件中、${Math.min(LOAD_STEP, currentFilteredPosts.length)}件を表示`;

            renderPosts(currentFilteredPosts, false);
        }

        function renderPosts(posts, append) {
            const container = document.getElementById('archive-list');
            const loadBtn = document.getElementById('pagination');

            const nextBatch = posts.slice(displayedCount, displayedCount + LOAD_STEP);

            if (nextBatch.length === 0 && displayedCount === 0) {
                container.innerHTML = '<p style="text-align:center;">該当する記事が見つかりませんでした。</p>';
                loadBtn.style.display = 'none';
                return;
            }

            nextBatch.forEach(post => {
                const card = document.createElement('a');
                card.href = post.url;
                card.className = 'post-card';
                // シンプルなカードデザイン
                card.innerHTML = `
                    <div class="date">${post.date}</div>
                    <div class="title">${post.title}</div>
                    <div style="font-size:0.85rem; color:#666; margin-top:5px; height:4.5em; overflow:hidden;">${post.description.substring(0, 60)}...</div>
                `;
                container.appendChild(card);
            });

            displayedCount += nextBatch.length;

            // ボタン表示制御
            if (displayedCount < posts.length) {
                loadBtn.style.display = 'block';
                document.getElementById('result-count').innerText = `全${posts.length}件中、${displayedCount}件を表示`;
            } else {
                loadBtn.style.display = 'none';
                document.getElementById('result-count').innerText = `全${posts.length}件を表示`;
            }
        }
    </script>
</body>

</html>